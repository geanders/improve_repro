## Example: Creating a 'Project' template {#module8}

We will walk through a real example, based on the experiences of one of our
Co-Is, of establishing the format for a research group's 'Project' template,
creating that template using RStudio, and initializing a new research project
directory using the created template. This example will be from a
laboratory-based research group that studies the efficacy of tuberculosis drugs
in a murine model.

**Objectives.** After this module, the trainee will be able to:

- Create a 'Project' template in RStudio to initialize consistently-formatted
'Project' directories
- Initialize a new 'Project' directory using this template

For this module, we'll show how to create an R Project template to manage data
from the example set of studies that we described in module 2.7. As a reminder,
this example set of studies covers a group of studies to explore novel
treatments for tuberculosis. Each study investigates how mice that are
challenged with tuberculosis respond to different treatments, both in terms of
how well they handle the treatment (assessed by checking if their weight
decreases notably while on treatment) and also how well the treatment manages to
limit the growth of tuberculosis in the mouse's lungs.

We will walk through the process of creating a project directory template that could
be used to manage and analyze data from any of the specific studies in this set of 
studies. We'll cover two ways that you could do this. The first is simpler---it involves
creating a basic file directory with the desired template files and file directory 
structure and then copying this file directory every time you want to start a new
project for a study in this set of studies. The second way is a bit more complex and 
time-consuming to set up, but has the benefit of providing a very nice interface for 
members of your laboratory group to use when they start a new project. This second way
is to create a full R Project template that can be accessed from RStudio anytime you 
create a new R Project. This type of template may not be worth the extra set-up time
for project types that your research group only uses rarely, but for types of projects
that your group conducts time and time again, it can be a powerful way to enforce a common
project directory structure, and this in turn will allow your group to create reusable
tools that work in coordination with this project structure. 

### Creating and using a basic template

Let's start by looking at the more basic way to create a project template. This involves 
no fancy tools---in fact, it's so straightforward that at first it might seem to simple 
to be useful. For this basic approach, you will create an example file directory that 
includes template files and that captures you desired project directory structure, and
then members of your group will copy and rename that template every time they start a 
new project of that type. 

Figure \@ref(fig:basicprojecttemplateuse) gives a basic walk-through of the
simple steps you'll use to start a new project directory once you've created
this type of template. First, you will find the project directory template in
your computer's file system, copy it to where you'd like to save the files for
the new project, and rename the directory to your new project's name. At this
point, you can use RStudio to make this directory an RStudio Project. Next,
you'll open the data collection template files and replace the placeholder
example data in the template (shown in red font) with the real data from your
study. The placeholder data can help you remember the format you should use to
record the real data. Finally, once you've recorded the data for the study or 
experiment, you can open the example report template file. If you've designed
this report template well, it should run with the new data you've recorded to 
create a report for the experiment. At this stage, you can add to the report 
or customize it for the new project by changing the Rmarkdown file and re-rendering
it to update the report. 

```{r basicprojecttemplateuse, fig.cap = "Steps in using a basic project directory template that you have created for a type of study or experiment.", fig.fullwidth = TRUE, out.width = "\\textwidth"}
knitr::include_graphics("figures/project_template_basic_use.png")
```

There are a few steps you'll need to take to create this type of basic project directory 
template: 

1. List the data you typically collect or files you create for that type of study or experiment
2. Create template files for any data collection that is typical for that type of study 
or experiment. Use example or placeholder data to create examples of those files.
3. Create a directory structure that divides the types of files into subdirectories of similar 
types.
4. Create one or more templates of report files that access and report on the data in the
project template

In modules [x], we showed how you can create tidy data collection templates to use to 
collect data, and how these can be paired with reproducible reporting tools to separate
the steps of data collection and reporting (modules [x] go into much more depth on these
reproducible reporting tools). Once you have decided on the types of data that you will 
usually collect for the type of study that this template is for, you can use that process
to create tidy data collection templates for each type of data.

In addition to the data that you record in the laboratory by hand, the type of study may 
also typically have data that's generated and recorded by laboratory equipment. For example, 
the type of study may often include data collected from flow cytometry, to measure certain 
cell populations in samples, or from mass spectometry, to measure levels of certain molecules. 
For these data, the recording format will typically be determined by the equipment, and 
so you won't need to create data collection templates for the data. However, you should store 
these data files in your project directory as well, where they are easy to access and integrate
with other data as you analyze the data for the study. 

The recorded data files and the files that come directly from equipment can all be considered
raw data files. In addition, you may typically create some files with pre-processed data. 
For example, if you have sequencing data [?], you may initially get large [what type] files
from the [what type] equipment. You may use a program like [what] to pre-process these files
to [do what]. In addition to saving the raw [what type] data files, you'll also want to 
save the processed data files in your project directory, since these are the files that you'll
analyze and integrate with other data from the project. 

Once you have determined the types of files that you'll normally include in your
project, you can decide how to organize them into subdirectories in a project
file directory. As you do this, it will be helpful to have example or template
files for each file type. For data that you will record yourself, these can be
the templates that you developed to collect the data in a tidy format (modules
[x]), while for data from equipment, these can just be one or more example files
from the equipment that you have collected for a past project. Having these example files
will help you to develop a template project report that can input the type of data that
you typically collect for this type of project. 

For the example set of studies for this module, there are a few types of data
that we plan to typically collect for each study. First, we will be recording
metadata for each experiment. This will include a study ID, as well as details
like the mouse strain that we used in that experiment, the route used to
administer the treatment, the treatments per week and total weeks of treatment,
the inoculum used for the challenge, and so on. Second, we'll be recording some
details about each experimental group that was tested. This includes the drug or
drugs that were tested, doses of each, and some exact details about the
treatment regimen for that group. Both of these types of data can be recorded at
the beginning of the study. Two other types of data will also be recorded, both
of them during the study rather than at the start. The first is weights of the
mice each week. These weights will be recorded for each treatment group each
week of treatment, to help see if there are drugs that are poorly tolerated by
the mice (which can show up through weight decreases in mice in that group). The
second is the bacterial load in the lungs of each mouse at the end of the
treatment period.

To create the project directory template for these studies, then, we'll create
data collection templates for each of these types of data. We'll create a
separate spreadsheet for each type of data, but we can group them into files if
we'd like. In our example, we created two files to store this type of data, one
for the metadata that are recorded at the start of the experiment (overall
experiment details and the details of each tested treatment) and one for the
data that are collected over the course of the experiment (mouse weights and
bacterial loads). Within each file, we've used separate sheets to record the 
different types of data. This allows us to keep similar types of data together
in the same file, while having a tidy collection format for each specific type
of data. [Figure] 

```{r projectdatacollection, fig.cap = "Data collection templates for the example project directory template. These templates were created in two files, one for metadata, which is saved in the main directory of the project, and one for data collected in the laboratory during the experiment, which is saved in the 'data' subdirectory. Each file is saved as a spreadsheet file, with two sheets in each file to store different types of data.", fig.fullwidth = TRUE, out.width = "\\textwidth"}
knitr::include_graphics("figures/project_data_collection.png")
```

All of these data collection files are designed using the principles of tidy data
collection (modules [x]). This will ensure that it will be easy to read these
recorded data in a programming language like R for analysis and visualization. 
Specifically, when we designed these template files, we thought a lot about 
things like using a two-dimensional structure (one row of header names and then
values within each of the columns), using column names that would be easy for
a programming language to parse (e.g., no special characters or spaces in the
column names), and so on. 

Now that we have these data collection templates for this type of study, we can 
decide how to organize the project directory into subdirectories with the different
types of data. In this case, we'll use a simple structure. We'll save the metadata
file in the top level of the project directory, since it provides metadata on the 
project as a whole. For the data that are collected during the experiment, we'll 
move that data collection file into a subdirectory called "data", with its own 
subdirectory for "recorded_data" (indicating that we recorded it by hand in the 
laboratory). If you had other types of data, you could create other subdirectories
for each type. For example, you could have a "flow_data" subdirectory for data
collected through flow cytometry. 

If you had raw data that required pre-processing, you could create
subdirectories both for the raw data and for the processed data that result from
pre-processing steps. For example, if you had data from [RNA sequencing?], you might
have [initial files] and [processed files], as well as a [bash?] script that you used
to generate the processed files from the initial raw data. You could create a directory 
called "raw_data" to use to store both the initial raw data and the script used to 
process that data, then a "rna_seq_data" subdirectory in the "data" subdirectory to 
store the smaller pre-processed files. 

```{r projecttemplatecomplex, fig.cap = "Example of a more complex project directory structure that could be created, with directories added to store data collected through flow cytometry and single cell RNA sequencing.", fig.fullwidth = FALSE, out.width = "\\textwidth"}
knitr::include_graphics("figures/project_template_morecomplex.png")
```

With the previous steps, you will have determined the types of files you normally 
have for this type of study, as well as structured the project directory to organize
these files. The next step is to create a template report. You can create this using
tools for reproducible reports---in R, a key tool for this is RMarkdown. Here, we'll 
cover using this tool for creating a report briefly, but there are many more details 
in modules [x]. 

Briefly, RMarkdown allows you to include both code and text meant for humans within 
a single, plain text document. This document can then be rendered, a process that 
executes the code and formats the text meant for humans, producing a document in an
easy-to-read format like Word or PDF. When it comes to project directories, it turns
out that you can use the directory structure in your favor when you create these 
reports. 

There are functions in R, for example, that will allow you to print all the
files in a specified subdirectory. Say that you have several flow cytometry files 
in a subdirectory of the "data" subdirectory called "flow_data". You could use this
function in R to create a list of all the files in that subdirectory, and then you 
can run other functions to do the same operations on all of those files. 

When you create a project directory template, we recommend that you create a
subdirectory named something like "reports" to use to store any Rmarkdown report
files for the project. This organization will make it clear where you've stored your
reports in the project directory. You'll be able to use file and directory pathnames
to access all the data in the project, so it will be easy to use the study's data
in the report even if they're in separate subdirectories. There's only one tool 
you'll need to do this---you'll need to learn how to use relative pathnames 
within R code to access files in a different part of your project directory. 

A pathname gives the directions to a file that is stored somewhere, for example
on your computer or a server. There are two ways to state a pathname---you can 
state it as either an absolute pathname or a relative pathname. An absolute 
pathname gives the directions to the file from the root directory of the 
computer where it's stored. In other words, it gives the directions starting 
from the very earliest point in the file directory for that computer. A relative
pathname, on the other hand, gives the directions to the file from something 
called the current working directory---that is, the directory that your current
program is currently operating from. 

You have likely already used relative pathnames extensively. If you read in a file
to a statistical program like R or Python, if that file is in the current working 
directory, you only have to give its file name to point the program to the file. 
You may not have realized it, but in this case, you were using the simplest type of 
relative pathname---since the file is already in your working directory, you 
don't need to give directions that move through different directories to get from
your current working directory to the file. 

If you have a file in a subdirectory of the current working directory, you can
use a relative pathname to access it by giving the direction through the
subdirectories to get to the file. For example, if you want to read in a file
named "bacterial_counts.xlsx" that is in a subdirectory of the current working
directory called "data", you could point to that file using the relative
pathname "data/bacterial_counts.xlsx". Instead, if you want to point to a file
with the same name that's in a subdirectory called "reported_data" of the "data"
subdirectory, you'd use the relative pathname
"data/reported_data/bacterial_counts.xlsx". 

You can use relative pathnames to navigate, too, to files that aren't in a 
subdirectory for the current file. To do this, you can use [abbreviations?]
for filenames. One of the most useful is ".", which stands for the parent 
(i.e., one above) the current working directory. For example, if you have 
a project directory, and you've put an RMarkdown file in the "reports" 
subdirectory, but within the code in that file you want to read in data from 
the "data" subdirectory of the same project, you could do so with a relative 
pathname like "./data/bacterial_counts.xlsx". This pathname says to move up 
one directory from the current working directory (in other words, to the 
directory that the current work directory is a subdirectory of) and then
look for a different subdirectory of that parent directory called "data", 
then read a file from that subdirectory. 

This strategy is necessary when you're using RMarkdown for your reports
and have created a project directory template with different subdirectories
for your data versus your reports. In an RMarkdown document, the code will 
run using the directory where the RMarkdown file is stored as the working
directory [correct even with Projects?]. Therefore, if you organize your 
project directory in the type of structure we've recommended, then you'll
need to use this type of relative pathname to access data elsewhere in 
the project directory when you write code for the report. 

We can take a look at how this works in the project directory template we
created for the example set of studies. In module [x] we gave details on 
what is included in the template report for this project directory template. 
Briefly, it is a file that will generate a couple of tables with metadata
on the experiment (overall experiment details as well as details on each 
of the treatments), then a graph showing mouse weights over time, then a 
graph showing the bacterial load at the end of the study in mice grouped 
by treatment, and finally a table giving the results of comparing the 
bacterial load in each treatment group to the bacterial load in the control
group.

We created an Rmarkdown file that does this analysis and visualization and
included it in the project template directory. This means that the report file
will be copied and available each time someone copies the project template
directory at the start of a new project. We wrote the code in a way that will
input data that are stored in the data collection files that also come with the
project directory template. Since we named those files in the directory
template, we can refer to them with the same name in the code for the report. We
wrote the code in the report in a way that it will still run if there are more
or fewer observations in any of the data collection files, so the report
template has some flexibility in terms of how each study in the set of studies
might vary. For example, in the example set of studies, some of the experiments
were run using only a control group of mice, while others were run to test as
many as [x] different treatment groups. The report template can accommodate
these differences across studies in the set of studies.

...

In many cases, you may have a more complex design for your project directory. For
example, if you were collecting flow cytometry data for the project as well, then 
you would want a subdirectory in the project that is specifically designed to 
store files from the flow cytometry component of the experiment. This subdirectory
would likely include several files, rather than just one. Further, you would not
know ahead of time what the name of these files would be (as you do with the data
collection template files that are included in the template directory). However, 
you can still easily write code for a template report file that will work with 
multiple files of a similar type, even if you don't know what the names will be, 
as long as you know what the name of their subdirectory will be. There are functions
in R like `list.files` that can be used to list all the file names for the files 
in a given directory. You can use this function to create a vector of all the file
names. For example, you could run: 

```{r eval = FALSE}
flow_filepaths <- list.files("../data/flow_data", full.names = TRUE)
```

to get an object (`flow_filepaths`) that lists each of the filepaths for the files
stored in the "flow_data" subdirectory within the "data" subdirectory of the 
project. You could then "map" a function or group of functions across these
files to read them in, process them, and join them into a single dataframe in R. 
By using this process, you can write template code in the report for the project
that should work in most cases for the data that you collect for a given type of 
study. 

The report template is included in the project directory template, so it will be
copied and available for you to use anytime you start a new project using that 
template. However, you are not obligated to keep the report identical to the template. 
Instead, the template report serves as a starting point, and you can add to it or
adapt it as you work on a study. 

For example, in our example template report, we've included the results of
applying a statistical test that compares each treatment group to the control
group. Instead, for a specific study of this type, you may want to control
treatments against each other. For example, some of the studies in this example
set of studies include a positive control group, where the mice are treated with
a drug that is already in common use for the disease. In some cases, the
researcher may want to control the bacterial load in groups treated with a novel
drug to groups treated with the positive control. You could easy add to the
report template in that case, adding statistical tests where you compare
different treatment groups to each other.

### Creating an R Project template

In the previous section, we covered a very basic way to make a project directory 
template: you make an example directory of project files, and then anytime you 
start a project for that type of study, you copy, rename, and use that example 
directory as a template. 

There is a second way to make project templates for your research group. This
method requires a lot more work at the beginning. However, it makes it very easy
for anyone in your group to use the template once it's been created. This method
is to create an R Studio Project template. To be clear, with the basic method
covered in the last chapter, you can create a project directory based on you
basic template and then convert it to an RStudio Project within RStudio.
However, with this second method, you will gain the option to create a new
project based on your template from within RStudio, and many of the details of
creating the template are encapsulated within the process, so you're more likely
to be able to enforce a common project directory structure across projects. 

This method does require a good bit of familiarity with R programming, as it
requires you to create a new R package. In this section, we'll go over the
process, using the example set of studies for this module as a motivating
example. ...

...

There are several steps that you'll take to create the RStudio Project
template: 

1. Decide on project directory structure
2. Create templates for recording data
3. Create a template for a report for the project
4. Create an R package to implement the Project template
5. Move the templates for data recording and the report into the "inst" 
directory of the Project package 
6. Write code in the package to create project structure and copy in templates
7. Customize the Project Wizard for the Project in the package code
8. Build the Project template package and share it with your research group

Several of these are the same as the steps to create a basic project directory
template. Specifically, steps 1--3 are the same steps that you would take to 
create a basic project directory template. 

The novel steps for this process come from step 4 and later. Rather than
creating a file directory that your research group will copy and rename, we'll
put all the elements of the project template within an R package that you can
build and then share with your research group. They will be able to install this
package, and then whenever they start a project, they will be able to initialize
it as this special type of project from within RStudio, as described in the
previous module.

Under this method, the template is put together and shared as an R package. An R
package is a collection of R code and data that extend the functionality of base
R. If you have coded with R, you've likely used these types of packages to get
access to useful functions. For example, the "tidyverse" (module [x]) is a suite
of popular R packages with functions for working with data. Anyone can create
and share an R package, either broadly and publicly by submitting it to a
repository like Bioconductor (in which case it will need to follow some
additional constraints and pass some checks) or privately as a compressed file
that anyone you share it with can download to their computer and install.

The new steps in this process start with step 4, which is to create an R package
to implement the Project template. You can create the framework for an R package
very easily in R study. Open RStudio, go to "File", and select "New Project", as
you would if you were creating any type of RStudio Project. Choose "New Directory", 
but then instead of choosing the generic "New Project", choose "R Package". This 
will create an open a new Project directory for you package, one that includes
templates for many of the files that you need to start a new R package. (As a note, 
this is using a special R project template, just like you'll be creating!)

[More on the initial package directory]

...

[How you can build the package and test it]

[How a different user can download and install a package that isn't on CRAN]

If you would like to create one of these RStudio Project templates for studies
in your research group, there are more details on the process at ... In addition, 
since this method requires building an R package, you may find resources on creating
R packages to be useful. One excellent book on the topic, which is available for
free online, is [R Packages] by Hadley Wickham and Jenny Bryan.

### Applied exercise
